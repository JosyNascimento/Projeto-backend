{{#if cart.products.length}}
    <table class="table">
        <thead>
            <tr>
                <th>Selecionar</th>
                <th>Imagem</th>
                <th>Produto</th>
                <th>Quantidade</th>
                <th>Preço Unitário</th>
                <th>Total</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {{#each cart.products}}
                <tr data-product-id="{{this.productId._id}}">
                    <td>
                        <input type="checkbox" id="select-{{this.productId._id}}" name="select-product" value="{{this.productId._id}}">
                        <label for="select-{{this.productId._id}}" class="visually-hidden">Selecionar {{this.productId.title}}</label>
                    </td>
                    <td>
                        {{#if this.productId.thumbnails}}
                            <img src="{{this.productId.thumbnails.[0]}}" alt="{{this.productId.title}}" width="50">
                        {{else}}
                            <img src="/images.jpg" class="d-block w-100" alt="{{this.productId.title}}" width="50">
                        {{/if}}
                    </td>
                    <td>{{this.productId.title}}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <input
                                type="number"
                                class="form-control form-control-sm"
                                id="quantity-{{this.productId._id}}"
                                value="{{this.quantity}}"
                                min="1"
                                style="width: 60px;"
                                onchange="updateQuantityInput('{{../cart._id}}', '{{this.productId._id}}', this.value)"
                            >
                        </div>
                    </td>
                    <td>R$ {{this.productId.price}}</td>
                    <td>R$ {{multiply this.productId.price this.quantity}}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart('{{../cart._id}}', '{{this.productId._id}}')">Excluir</button>
                    </td>
                </tr>
            {{/each}}
        </tbody>
    </table>

    <div>
        <p>Preço Total: R$ {{totalPrice}}</p>
        <p>Quantidade de Produtos: {{totalQuantity}}</p>
    </div>

    <div class="finalize-btn mt-3">
        <a href="/checkout/{{cart._id}}" class="btn btn-primary">Finalizar Compra</a>

        <a href="/api/cart/clear/{{cart._id}}" class="btn btn-danger">Limpar Carrinho</a>

        <a href="/" class="btn btn-primary">Continuar Comprando</a>
    </div>
{{else}}
    <p>Seu carrinho está vazio.</p>
    <a href="/" class="btn btn-primary">Continuar comprando</a>
{{/if}}

<script>
    // ===================================================================
    // FUNÇÕES JAVASCRIPT MOVIDAS PARA O ESCOPO GLOBAL
    // Assim, o HTML pode chamá-las diretamente via onclick.
    // ===================================================================

    async function addToCart(productId, quantity = 1) {
        try {
            // Verifique se a rota '/cart/add' é a correta no seu backend,
            // ou se precisa ser '/api/cart/add'
            const response = await fetch('/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ productId, quantity }),
            });

            if (response.ok) {
                const data = await response.json();
                const cartQuantityElement = document.getElementById('cart-quantity');
                if (cartQuantityElement) {
                    cartQuantityElement.textContent = data.totalQuantity;
                }
                alert('Produto adicionado ao carrinho com sucesso!');
            } else {
                const error = await response.json();
                alert('Erro ao adicionar ao carrinho: ' + error.message);
            }
        } catch (error) {
            console.error('Erro ao adicionar ao carrinho:', error);
            alert('Erro inesperado ao adicionar ao carrinho.');
        }
    }

    async function removeFromCart(cartId, productId) {
        try {
            // **IMPORTANTE:** Confirme esta rota com a do seu `cart.router.js`
            // Deve ser exatamente a mesma, incluindo '/cart' ou '/api/cart'
            const response = await fetch(`/api/cart/${cartId}/product/${productId}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                alert('Produto excluído com sucesso!');
                window.location.reload(); // Recarrega a página para refletir a mudança
            } else {
                const error = await response.json();
                alert('Erro ao excluir o produto do carrinho: ' + (error.message || 'Erro desconhecido.'));
            }
        } catch (error) {
            console.error('Erro de rede ou fetch falhou:', error);
            alert('Erro inesperado ao excluir o produto do carrinho. Verifique a conexão ou os logs do servidor.');
        }
    }

    async function updateQuantityInput(cartId, productId, newQuantity) {
        try {
            // **IMPORTANTE:** Confirme esta rota com a do seu `cart.router.js` para UPDATE
            // Deve ser exatamente a mesma, incluindo '/carts' ou '/api/carts'
            const response = await fetch(`/carts/${cartId}/product/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ quantity: parseInt(newQuantity, 10) }),
            });

            if (response.ok) {
                alert('Quantidade atualizada com sucesso!');
                window.location.reload(); // Recarrega a página
            } else {
                const error = await response.json();
                alert('Erro ao atualizar a quantidade: ' + error.message);
            }
        } catch (error) {
            console.error('Erro ao atualizar a quantidade:', error);
            alert('Erro inesperado ao atualizar a quantidade.');
        }
    }

    async function clearMyCart(cartId) {
        try {
            // **IMPORTANTE:** Confirme esta rota com a do seu `cart.router.js` para CLEAR
            // Deve ser exatamente a mesma, incluindo '/api/cart/clear'
            const response = await fetch(`/api/cart/clear/${cartId}`, {
                method: 'DELETE', // Recomenda-se DELETE para limpar recursos
            });

            if (response.ok) {
                const data = await response.json();
                alert(data.message || 'Carrinho limpo com sucesso!');
                window.location.reload();
            } else {
                const error = await response.json();
                alert('Erro ao limpar o carrinho: ' + error.message);
            }
        } catch (error) {
            console.error('Erro ao limpar o carrinho:', error);
            alert('Erro inesperado ao limpar o carrinho.');
        }
    }

    // ===================================================================
    // ESTE BLOCO DOMContentLoaded AGORA CONTÉM APENAS A LÓGICA QUE
    // PRECISA ESPERAR O DOM CARREGAR COMPLETAMENTE.
    // As funções chamadas pelo HTML diretamente já estão no escopo global.
    // ===================================================================
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Confirme esta rota: '/carts/quantity' ou '/api/carts/quantity'
            const response = await fetch('/api/carts/quantity'); 
            if (response.ok) {
                const cartData = await response.json();
                const totalQuantity = cartData.totalQuantity || 0;
                const cartQuantityElement = document.getElementById('cart-quantity');
                if (cartQuantityElement) {
                    cartQuantityElement.textContent = totalQuantity;
                }
            } else {
                console.error('Erro ao carregar quantidade do carrinho inicial.');
            }
        } catch (error) {
            console.error('Erro ao carregar quantidade do carrinho inicial:', error);
        }

        // Adicione event listeners aos botões "Comprar" dos seus produtos
        const buyButtons = document.querySelectorAll('.botao-comprar');
        buyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.getAttribute('data-product-id');
                addToCart(productId);
            });
        });
    });
</script>